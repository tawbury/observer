name: Deploy to Azure VM (After Build)

# íŠ¸ë¦¬ê±°: build-push-tag ì›Œí¬í”Œë¡œìš° ì™„ë£Œ í›„ ìë™ ì‹¤í–‰
on:
  workflow_run:
    workflows: ["Build & Push Observer Image (Tag)"]
    types:
      - completed

  # ìˆ˜ë™ ì‹¤í–‰ ì˜µì…˜
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to deploy (timestamp format: 20YYMMDD-HHMMSS)'
        required: true
        type: string

jobs:
  deploy:
    name: Deploy to Observer VM
    runs-on: ubuntu-latest
    # build-push-tagì´ ì„±ê³µí–ˆì„ ë•Œë§Œ ì‹¤í–‰
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download IMAGE_TAG from build artifact
        uses: actions/download-artifact@v4
        with:
          name: image-tag
          path: ./
        continue-on-error: true

      - name: Determine IMAGE_TAG
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            IMAGE_TAG="${{ inputs.image_tag }}"
            echo "ğŸ“ Using image tag from manual input: $IMAGE_TAG"
          else
            # artifactì—ì„œ IMAGE_TAG ì½ê¸°
            if [ -f image_tag.txt ]; then
              IMAGE_TAG=$(cat image_tag.txt | xargs)  # trim whitespace
              echo "ğŸ“¦ IMAGE_TAG from build artifact: $IMAGE_TAG"
            else
              echo "âš ï¸  image_tag.txt not found, using fallback..."
              # fallback: tag ref ì‚¬ìš© (ë¹Œë“œ ì›Œí¬í”Œë¡œìš°ê°€ tagë¡œ íŠ¸ë¦¬ê±°ëœ ê²½ìš°)
              IMAGE_TAG="${{ github.ref_name }}"
              echo "ğŸ·ï¸  IMAGE_TAG from git ref: $IMAGE_TAG"
            fi
          fi

          # íƒœê·¸ í˜•ì‹ ê²€ì¦: 20YYMMDD-HHMMSS (ì˜ˆ: 20250125-112345)
          if [[ ! "$IMAGE_TAG" =~ ^20[0-9]{6}-[0-9]{6}$ ]]; then
            echo "âŒ FATAL: Invalid tag format!"
            echo "   Got: $IMAGE_TAG"
            echo "   Expected: 20YYMMDD-HHMMSS (e.g., 20250125-112345)"
            echo "   Pattern: 20 + 6 digits (YYMMDD) + hyphen + 6 digits (HHMMSS)"
            exit 1
          fi

          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "âœ… Deploying image tag: $IMAGE_TAG (format validated)"

      - name: Print Deploy Context
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ Observer Deployment Context"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Image Tag:      ${{ steps.tag.outputs.IMAGE_TAG }}"
          echo "Target Host:    ${{ secrets.SSH_HOST }}"
          echo "SSH User:       ${{ secrets.SSH_USER }}"
          echo "Deploy Dir:     ${{ secrets.SERVER_DEPLOY_DIR || '/home/azureuser/observer-deploy' }}"
          echo "Registry:       ghcr.io/tawbury/observer"
          echo "Trigger:        ${{ github.event_name }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Setup SSH known hosts
        run: |
          if [ -n "${{ secrets.SSH_KNOWN_HOSTS }}" ]; then
            echo "ğŸ”’ Setting up SSH host key verification..."
            mkdir -p ~/.ssh
            echo "${{ secrets.SSH_KNOWN_HOSTS }}" > ~/.ssh/known_hosts
            chmod 700 ~/.ssh
            chmod 600 ~/.ssh/known_hosts
            echo "âœ… SSH known_hosts configured"
            echo "   Host key verification: ENABLED"
            echo "   Entries: $(wc -l < ~/.ssh/known_hosts)"
          else
            echo "âš ï¸  WARNING: SSH_KNOWN_HOSTS secret not configured"
            echo "   Host key verification: DISABLED"
            echo "   Deployment will proceed without strict host checking"
            echo "   Consider adding SSH_KNOWN_HOSTS secret for security"
          fi

      - name: Upload docker-compose file
        run: |
          echo "ğŸ“¦ Uploading docker-compose.server.yml to server..."

          # Create temporary SSH key file
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # Upload file
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            infra/docker/compose/docker-compose.server.yml \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.SERVER_DEPLOY_DIR || '/home/azureuser/observer-deploy' }}/

          # Cleanup
          rm -f ~/.ssh/deploy_key

          echo "âœ… docker-compose.server.yml uploaded successfully"

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || '22' }}
          script: |
            set -e

            DEPLOY_DIR="${{ secrets.SERVER_DEPLOY_DIR || '/home/azureuser/observer-deploy' }}"
            IMAGE_TAG="${{ steps.tag.outputs.IMAGE_TAG }}"

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸš€ Starting deployment on server"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "Deploy Directory: $DEPLOY_DIR"
            echo "Image Tag:        $IMAGE_TAG"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            cd "$DEPLOY_DIR"

            # Preflight ê²€ì¦ (ë””ë²„ê¹…ìš©)
            echo "Current directory: $(pwd)"
            echo "Available files:"
            ls -la | head -10
            echo "IMAGE_TAG is set: $([ -n "$IMAGE_TAG" ] && echo "true" || echo "false")"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (ì˜¬ë°”ë¥¸ ì¸ì ìˆœì„œ: DEPLOY_DIR COMPOSE_FILE IMAGE_TAG MODE)
            ./server_deploy.sh "$DEPLOY_DIR" docker-compose.server.yml "$IMAGE_TAG" deploy

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… Deployment completed successfully"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Post-deploy health check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || '22' }}
          script: |
            set -e

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ” Running post-deploy health check"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "Endpoint:     http://localhost:8000/health"
            echo "Timeout:      60 seconds"
            echo "Retry every:  5 seconds"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            # Health check retry loop (60 seconds total, 5 second intervals)
            MAX_ATTEMPTS=12
            ATTEMPT=0
            SUCCESS=false

            while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
              ATTEMPT=$((ATTEMPT + 1))
              echo "Attempt $ATTEMPT/$MAX_ATTEMPTS: Checking health..."

              if curl -sf http://localhost:8000/health > /dev/null 2>&1; then
                echo "âœ… Health check PASSED"
                SUCCESS=true
                break
              else
                echo "â³ Service not ready yet, waiting 5 seconds..."
                sleep 5
              fi
            done

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            if [ "$SUCCESS" = true ]; then
              echo "âœ… POST-DEPLOY HEALTH CHECK: PASSED"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              exit 0
            else
              echo "âŒ POST-DEPLOY HEALTH CHECK: FAILED"
              echo "Service did not become healthy within 60 seconds"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo ""
              echo "ğŸ” Collecting diagnostics..."
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

              cd "${{ secrets.SERVER_DEPLOY_DIR || '/home/azureuser/observer-deploy' }}"

              echo ""
              echo "ğŸ“¦ Container Status:"
              docker compose ps || true

              echo ""
              echo "ğŸ“‹ Observer Container Logs (last 80 lines):"
              docker compose logs observer --tail 80 || true

              echo ""
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "âš ï¸  Deployment may have issues. Manual rollback recommended:"
              echo "   ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}"
              echo "   cd ${{ secrets.SERVER_DEPLOY_DIR || '/home/azureuser/observer-deploy' }}"
              echo "   ./server_deploy.sh rollback"
              exit 1
            fi

      - name: Deployment Summary
        if: success()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… DEPLOYMENT SUCCESS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Image Tag:    ${{ steps.tag.outputs.IMAGE_TAG }}"
          echo "Target:       ${{ secrets.SSH_HOST }}"
          echo "Status:       Deployed and running"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ” Verify deployment:"
          echo "  ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}"
          echo "  docker ps"
          echo "  curl http://localhost:8000/health"

      - name: Deployment Failed
        if: failure()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ DEPLOYMENT FAILED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Image Tag:    ${{ steps.tag.outputs.IMAGE_TAG }}"
          echo "Target:       ${{ secrets.SSH_HOST }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ” Troubleshooting:"
          echo "  1. SSH into server and check logs:"
          echo "     ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}"
          echo "     cd ${{ secrets.SERVER_DEPLOY_DIR || '/home/azureuser/observer-deploy' }}"
          echo "     docker compose logs"
          echo ""
          echo "  2. Rollback to previous version:"
          echo "     ./server_deploy.sh rollback"
          exit 1
