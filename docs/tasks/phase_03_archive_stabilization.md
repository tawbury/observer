# Phase 03: Archive Stabilization

**목적:** 로그 생성 미작동 문제 해결 및 아카이브 안정화  
**선수 조건:** Phase 02 KIS Integration 완료  
**완료 기준:** 지속적인 로그 생성 증명, 롤링/보존 정책 동작, 장애 모드 대응 완료

---

## 개요

### 목표
- "로그 미생성" 근본 원인 해결
- 아카이브 작성기 경로/볼륨 정합성 확보
- 롤링/보존/백필 정책 구현
- 관측가능성 및 헬스체크 구축
- 장애 모드 테스트 및 대응

### 배경
Phase 03 Archive Runner는 구현되었으나 `on_snapshot()` 호출 트리거 불명확으로 로그가 생성되지 않습니다. 이를 해결하고 안정적인 아카이브 시스템을 구축합니다.

---

## Deliverables

- [ ] 로그 생성 근본 원인 해결 보고서
- [ ] 아카이브 경로/볼륨 정합성 증명
- [ ] 롤링/보존/백필 정책 구현
- [ ] 관측가능성 대시보드
- [ ] 장애 모드 테스트 결과

---

## Tasks

### 1. 로그 생성 근본 원인 해결
- [ ] on_snapshot() 호출 트리거 확인
  - [ ] 현재 메인 루프 분석 (while True: time.sleep(0.5))
  - [ ] observer.start() 호출 여부 확인
  - [ ] KIS 연동 코드와 Observer 연결점 확인
- [ ] 스냅샷 생성 루프 구현
  - [ ] 외부 트리거 대신 내부 스냅샷 생성 루프 구현
  - [ ] Phase 02 KIS 연동 결과를 스냅샷으로 변환
  - [ ] 주기적 스냅샷 생성 스케줄러 연결
- [ ] 파이프라인 흐름 검증
  - [ ] 스냅샷 → Validation → Guard → Enrichment → EventBus → JsonlFileSink
  - [ ] 각 단계별 로깅 추가
  - [ ] 에러 발생 시 흐름 추적 가능성 확보

### 2. 아카이브 작성기 경로/볼륨 정합성
- [ ] 경로 계약 일치성 확인
  - [ ] config/observer/ 경로가 실제 사용되는지 확인
  - [ ] QTS_OBSERVER_STANDALONE 환경변수 효과 검증
  - [ ] paths.py observer_asset_dir() 로직 확인
- [ ] 볼륨 마운트 정합성
  - [ ] docker-compose.yml 볼륨 설정 검토
  - [ ] 호스트 경로와 컨테이너 경로 매핑 확인
  - [ ] 파일 쓰기 권한 문제 해결
- [ ] 디렉토리 구조 자동 생성
  - [ ] swing/, scalp/, system/ 하위 디렉토리 자동 생성
  - [ ] YYYYMMDD/HH_00.jsonl 롤링 경로 생성
  - [ ] 권한 설정 자동화

### 3. 롤링/보존/백필 정책
- [ ] 롤링 정책 구현
  - [ ] Swing: 시간 단위 롤링 (HH_00.jsonl)
  - [ ] Scalp: 분초 단위 롤링 (HH_MM_SS.jsonl)
  - [ ] System: 일자 단위 롤링 (YYYYMMDD.jsonl)
- [ ] 보존 정책 구현
  - [ ] Raw Logs 3-10일 보존 설정
  - [ ] 오래된 파일 자동 삭제 로직
  - [ ] 디스크 공간 모니터링 및 정리
- [ ] 백필 정책 구현
  - [ ] 장애 시 누락 데이터 식별
  - [ ] 재수집 및 백필 로직
  - [ ] 중복 방지 (Idempotency)

### 4. 관측가능성 및 헬스체크
- [ ] 파일 생성 모니터링
  - [ ] config/observer/observer.jsonl 존재 여부 확인
  - [ ] 파일 크기 시간별 변화 추적
  - [ ] JSONL 라인 수 증가 확인
- [ ] 파이프라인 상태 모니터링
  - [ ] 스냅샷 수신 카운트
  - [ ] Validation 실패율
  - [ ] Guard 차단율
  - [ ] EventBus/Sink 오류율
- [ ] 헬스체크 엔드포인트
  - [ ] /health 상태 확인 API
  - [ ] 메트릭 수집 (Prometheus)
  - [ ] 로그 집계 (Loki)

### 5. 장애 모드 테스트
- [ ] 스냅샷 미수신 시뮬레이션
  - [ ] 외부 트리거 없는 상태 테스트
  - [ ] 타임아웃 및 재시도 동작 확인
  - [ ] 장애 알림 발생 확인
- [ ] 권한 거부 시뮬레이션
  - [ ] 파일 쓰기 권한 제거 테스트
  - [ ] 에러 처리 및 복구 절차 확인
  - [ ] 대체 경로 동작 확인
- [ ] 디스크 공간 부족 시뮬레이션
  - [ ] 디스크 공간 모니터링 동작
  - [ ] 오래된 파일 정리 동작
  - [ ] 쓰기 중단 및 알림 발생
- [ ] 네트워크 장애 시뮬레이션
  - [ ] KIS 연결 끊김 시나리오
  - [ ] 캐시된 데이터 처리
  - [ ] 재연결 후 데이터 보상

---

## Test Plan

### 환경 준비
1. KIS 연동된 Phase 02 환경
2. 모니터링 대시보드 구축
3. 장애 시뮬레이션 도구 준비

### 실행 단계
1. 기본 동작 테스트
   - 스냅샷 생성 → 파일 출력 확인
   - 롤링 정책 동작 확인
   - 1시간 연속 운영 테스트

2. 장애 복구 테스트
   - 각 장애 시나리오별 복구 시간 측정
   - 데이터 누락 여부 확인
   - 알림 발생 및 확인

3. 장시간 운영 테스트
   - 24시간 연속 운영 안정성
   - 디스크 사용량 추이
   - 성능 저하 여부 확인

4. 부하 테스트
   - 최대 수집량 처리 테스트
   - 동시 쓰기 안정성
   - 메모리 사용량 모니터링

---

## Done Criteria

### 기술적 완료
- [ ] on_snapshot()이 지속적으로 호출되어 로그 생성됨
- [ ] config/observer/ 경로에 파일이 정상적으로 생성됨
- [ ] 롤링/보존 정책이 아키텍처대로 동작함
- [ ] 모든 장애 시나리오에서 자동 복구됨

### 운영적 완료
- [ ] 24시간 연속 운영 시 로그 누락률 < 0.01%
- [ ] 장애 발생 시 복구 시간 < 3분
- [ ] 디스크 사용량이 예상 범위 내 유지됨
- [ ] 헬스체크 대시보드 정상 동작

### 문서적 완료
- [ ] 운영 체크리스트 완성
- [ ] 장애 처리 절차 문서화
- [ ] 모니터링 지표 정의 완료
- [ ] Phase 04 ETL을 위한 데이터 계약 확정

---

## 의존성

- **선수 조건:** Phase 02 KIS Integration (스냅샷 원천)
- **후속 영향:** Phase 04 Trading DB Runner (아카이브 데이터 소스)

---

## 리스크 및 완화

### 고위험
- on_snapshot() 트리거 불명확 → 로그 생성 지속 실패
- 경로 불일치 → 파일이 다른 위치에 생성됨
- 디스크 공간 부족 → 운영 중단

### 완화 조치
- 스냅샷 생성 루프 명시적 구현
- 모든 경로 조합 테스트 및 자동 보정
- 디스크 모니터링 및 선제적 정책 적용
