name: Deploy to Azure VM (Tag-based)

# íŠ¸ë¦¬ê±°: íƒ€ì„ìŠ¤íƒ¬í”„ íƒœê·¸ í‘¸ì‹œ (20YYMMDD-HHMMSS íŒ¨í„´)
# ì˜ˆ: 20260123-173045
on:
  push:
    tags:
      - '20*'

  # ì„ íƒì : ìˆ˜ë™ ì‹¤í–‰ (íŠ¹ì • ì´ë¯¸ì§€ íƒœê·¸ ì§€ì • ê°€ëŠ¥)
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to deploy (timestamp format: 20YYMMDD-HHMMSS)'
        required: true
        type: string

jobs:
  deploy:
    name: Deploy to Observer VM
    runs-on: ubuntu-latest

    steps:
      - name: Determine IMAGE_TAG
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            IMAGE_TAG="${{ inputs.image_tag }}"
          else
            IMAGE_TAG="${{ github.ref_name }}"
          fi
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "âœ… Deploying image tag: $IMAGE_TAG"

      - name: Print Deploy Context
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ Observer Deployment Context"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Image Tag:      ${{ steps.tag.outputs.IMAGE_TAG }}"
          echo "Target Host:    ${{ secrets.SSH_HOST }}"
          echo "SSH User:       ${{ secrets.SSH_USER }}"
          echo "Deploy Dir:     ${{ secrets.SERVER_DEPLOY_DIR || '/home/azureuser/observer-deploy' }}"
          echo "Registry:       ghcr.io/tawbury/observer"
          echo "Trigger:        ${{ github.event_name }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Setup SSH known hosts
        run: |
          if [ -n "${{ secrets.SSH_KNOWN_HOSTS }}" ]; then
            echo "ğŸ”’ Setting up SSH host key verification..."
            mkdir -p ~/.ssh
            echo "${{ secrets.SSH_KNOWN_HOSTS }}" > ~/.ssh/known_hosts
            chmod 700 ~/.ssh
            chmod 600 ~/.ssh/known_hosts
            echo "âœ… SSH known_hosts configured"
            echo "   Host key verification: ENABLED"
            echo "   Entries: $(wc -l < ~/.ssh/known_hosts)"
          else
            echo "âš ï¸  WARNING: SSH_KNOWN_HOSTS secret not configured"
            echo "   Host key verification: DISABLED"
            echo "   Deployment will proceed without strict host checking"
            echo "   Consider adding SSH_KNOWN_HOSTS secret for security"
          fi

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || '22' }}
          script: |
            set -e

            DEPLOY_DIR="${{ secrets.SERVER_DEPLOY_DIR || '/home/azureuser/observer-deploy' }}"
            IMAGE_TAG="${{ steps.tag.outputs.IMAGE_TAG }}"

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸš€ Starting deployment on server"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "Deploy Directory: $DEPLOY_DIR"
            echo "Image Tag:        $IMAGE_TAG"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            cd "$DEPLOY_DIR"

            # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
            ./server_deploy.sh deploy "$IMAGE_TAG"

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… Deployment completed successfully"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Post-deploy health check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || '22' }}
          script: |
            set -e

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ” Running post-deploy health check"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "Endpoint:     http://localhost:8000/health"
            echo "Timeout:      60 seconds"
            echo "Retry every:  5 seconds"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            # Health check retry loop (60 seconds total, 5 second intervals)
            MAX_ATTEMPTS=12
            ATTEMPT=0
            SUCCESS=false

            while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
              ATTEMPT=$((ATTEMPT + 1))
              echo "Attempt $ATTEMPT/$MAX_ATTEMPTS: Checking health..."

              if curl -sf http://localhost:8000/health > /dev/null 2>&1; then
                echo "âœ… Health check PASSED"
                SUCCESS=true
                break
              else
                echo "â³ Service not ready yet, waiting 5 seconds..."
                sleep 5
              fi
            done

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            if [ "$SUCCESS" = true ]; then
              echo "âœ… POST-DEPLOY HEALTH CHECK: PASSED"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              exit 0
            else
              echo "âŒ POST-DEPLOY HEALTH CHECK: FAILED"
              echo "Service did not become healthy within 60 seconds"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo ""
              echo "ğŸ” Collecting diagnostics..."
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

              cd "${{ secrets.SERVER_DEPLOY_DIR || '/home/azureuser/observer-deploy' }}"

              echo ""
              echo "ğŸ“¦ Container Status:"
              docker compose ps || true

              echo ""
              echo "ğŸ“‹ Observer Container Logs (last 80 lines):"
              docker compose logs observer --tail 80 || true

              echo ""
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "âš ï¸  Deployment may have issues. Manual rollback recommended:"
              echo "   ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}"
              echo "   cd ${{ secrets.SERVER_DEPLOY_DIR || '/home/azureuser/observer-deploy' }}"
              echo "   ./server_deploy.sh rollback"
              exit 1
            fi

      - name: Deployment Summary
        if: success()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… DEPLOYMENT SUCCESS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Image Tag:    ${{ steps.tag.outputs.IMAGE_TAG }}"
          echo "Target:       ${{ secrets.SSH_HOST }}"
          echo "Status:       Deployed and running"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ” Verify deployment:"
          echo "  ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}"
          echo "  docker ps"
          echo "  curl http://localhost:8000/health"

      - name: Deployment Failed
        if: failure()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ DEPLOYMENT FAILED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Image Tag:    ${{ steps.tag.outputs.IMAGE_TAG }}"
          echo "Target:       ${{ secrets.SSH_HOST }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ” Troubleshooting:"
          echo "  1. SSH into server and check logs:"
          echo "     ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}"
          echo "     cd ${{ secrets.SERVER_DEPLOY_DIR || '/home/azureuser/observer-deploy' }}"
          echo "     docker compose logs"
          echo ""
          echo "  2. Rollback to previous version:"
          echo "     ./server_deploy.sh rollback"
          exit 1
