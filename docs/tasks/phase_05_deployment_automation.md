# Phase 05: Deployment Automation

**목적:** GitHub Actions/Terraform 기반 배포 자동화 완성  
**선수 조건:** Phase 01 Foundation (기반 환경)  
**완료 기준:** 전체 파이프라인 자동화, Secrets 계약 준수, 롤백/헬스체크 게이트 구축

---

## 개요

### 목표
- GitHub Actions 파이프라인 완성
- Terraform 인프라 배포 자동화
- Secrets 및 환경변수 계약 준수
- 프로덕션 유사 배포 리허설
- 롤백 및 헬스체크 게이트 구축

### 배경
현재 배포 자동화가 부분적으로 구현되었으나, 환경변수 표준화와 전체 파이프라인 완성이 필요합니다.

---

## Deliverables

- [ ] 완성된 GitHub Actions 파이프라인
- [ ] Terraform 환경변수 주입 자동화
- [ ] Secrets 계약 검증 시스템
- [ ] 프로덕션 배포 리허설 결과
- [ ] 롤백/헬스체크 게이트

---

## Tasks

### 1. GitHub Actions 파이프라인 완성
- [ ] deploy.yml 파이프라인 검토 및 완성
  - [ ] 테스트 단계 (Unit/Integration) 추가
  - [ ] Docker 빌드 최적화
  - [ ] Registry 푸시 자동화
  - [ ] 배포 후 헬스체크 추가
- [ ] deploy-infrastructure.yml 개선
  - [ ] Terraform plan/apply 자동화
  - [ ] 상태 백업 및 복원
  - [ ] 인프라 변경 검토 게이트
- [ ] scheduled-ops.yml 정기 작업
  - [ ] 백업 스케줄 자동화
  - [ ] 로그 정리 작업
  - [ ] 모니터링 리포트 생성

### 2. Terraform 환경변수 주입
- [ ] 환경별 변수 관리
  - [ ] dev/staging/prod 환경 분리
  - [ ] tfvars 파일 자동 선택 로직
  - [ ] 민감 정보 GitHub Secrets 연동
- [ ] 변수 주입 파이프라인
  - [ ] GitHub Actions → Terraform 변수 전달
  - [ ] Azure 인증 정보 자동 설정
  - [ ] 동적 설정값 처리 (IP, 리소스 ID 등)
- [ ] 상태 관리 개선
  - [ ] Remote State Lock 최적화
  - [ ] 상태 백업 자동화
  - [ ] 다중 환경 상태 분리

### 3. Secrets 계약 검증
- [ ] Secrets 목록 정의
  - [ ] KIS API 인증 정보
  - [ ] Azure 서비스 주체 정보
  - [ ] 데이터베이스 연결 정보 (Phase 04)
  - [ ] 모니터링 서비스 토큰
- [ ] 계약 준수 검증
  - [ ] 코드 내 하드코딩 없음 검증
  - [ ] 로그에 민감 정보 노출 없음 확인
  - [ ] 권한 최소 원칙 준수
- [ ] Secrets 관리 자동화
  - [ ] GitHub Secrets 동기화
  - [ ] 만료 예측 및 갱신 알림
  - [ ] 접근 권한 감사

### 4. 프로덕션 유사 배포 리허설
- [ ] 스테이징 환경 구축
  - [ ] 프로덕션과 동일한 구성
  - [ ] 실제 데이터와 유사한 테스트 데이터
  - [ ] 동일한 모니터링 구성
- [ ] 배포 시나리오 테스트
  - [ ] 정상 배포 흐름 테스트
  - [ ] 부분 실패 시나리오
  - [ ] 롤백 시나리오
- [ ] 성능 및 안정성 검증
  - [ ] 배포 시간 측정
  - [ ] 서비스 중단 시간 측정
  - [ ] 리소스 사용량 모니터링

### 5. 롤백 및 헬스체크 게이트
- [ ] 헬스체크 시스템 구축
  - [ ] 애플리케이션 헬스체크 엔드포인트
  - [ ] 인프라 상태 확인
  - [ ] 데이터 연결 상태 확인
- [ ] 롤백 자동화
  - [ ] 이전 버전으로 롤백 파이프라인
  - [ ] 데이터 롤백 (필요시)
  - [ ] 설정 롤백
- [ ] 배포 게이트 구현
  - [ ] 헬스체크 실패 시 자동 롤백
  - [ ] 수동 승인 게이트
  - [ ] 알림 및 보고 자동화

---

## Test Plan

### 환경 준비
1. GitHub Actions 워크플로우 접근 권한
2. Azure 구독 및 서비스 주체
3. 스테이징 환경 구축

### 실행 단계
1. 파이프라인 테스트
   - 전체 배파 실행 테스트
   - 각 단계별 성공/실패 테스트
   - 병렬 실행 안정성 테스트

2. Secrets 테스트
   - 민감 정보 노출 검증
   - 권한 테스트
   - 만료 처리 테스트

3. 리허설 테스트
   - 스테이징 환경 배포
   - 장애 주입 및 복구 테스트
   - 롤백 시나리오 실행

4. 게이트 테스트
   - 헬스체크 실패 시 롤백
   - 수동 승인 프로세스
   - 알림 발생 확인

---

## Done Criteria

### 기술적 완료
- [ ] main 브랜치 푸시 시 전체 배파 자동 실행됨
- [ ] 모든 Secrets가 GitHub Secrets로 관리됨
- [ ] 헬스체크 실패 시 자동 롤백됨
- [ ] 스테이징 환경에서 프로덕션 배파 시뮬레이션 가능함

### 운영적 완료
- [ ] 배포 시간 < 15분
- [ ] 서비스 중단 시간 < 2분
- [ ] 롤백 시간 < 5분
- [ ] 배포 성공률 > 95%

### 보안적 완료
- [ ] 민감 정보가 코드에 노출되지 않음
- [ ] 접근 권한이 최소 원칙을 준수함
- [ ] 감사 로그가 자동 수집됨

---

## 의존성

- **선수 조건:** Phase 01 Foundation (기반 환경)
- **병행 가능:** Phase 02-03 (애플리케이션 개발)
- **후속 영향:** 모든 Phase의 운영 안정성

---

## 리스크 및 완화

### 고위험
- Secrets 노출 → 보안 사고
- 배파 실패 → 서비스 중단
- 롤백 실패 → 장기 장애

### 완화 조치
- Secrets 검증 자동화
- 다중 환경 테스트
- 롤백 파이프라인 별도 검증

---

## 운영 가이드

### 정기 작업
- [ ] 월간 배파 파이프라인 점검
- [ ] 분기별 Secrets 만료 확인
- [ ] 반기적 리허설 실행

### 장애 대응
- [ ] 배파 실패 시 수동 롤백 절차
- [ ] Secrets 노출 시 비상 대응
- [ ] 인프라 장애 시 복구 절차
