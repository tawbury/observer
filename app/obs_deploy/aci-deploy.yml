apiVersion: '2019-12-01'
name: observer-prod
properties:
  containers:
  - name: observer
    properties:
      image: observercontainerreg.azurecr.io/observer:latest
      resources:
        requests:
          cpu: 1.0
          memoryInGb: 1.5
      ports:
      - port: 8000
        protocol: TCP
      environmentVariables:
      - name: OBSERVER_STANDALONE
        value: '1'
      - name: OBSERVER_DATA_DIR
        value: /app/data/observer
      - name: OBSERVER_LOG_DIR
        value: /app/logs
      - name: OBSERVER_CONFIG_DIR
        value: /app/config
      - name: DB_HOST
        secureValue: postgres-prod.postgres.database.azure.com
      - name: DB_USER
        secureValue: postgres@postgres-prod
      - name: DB_PASSWORD
        secureValue: ChangeMe@123456
      - name: DB_NAME
        value: observer
      - name: DB_PORT
        value: '5432'
      volumeMounts:
      - name: logs
        mountPath: /app/logs
      - name: config
        mountPath: /app/config
      - name: data
        mountPath: /app/data
  
  - name: postgres
    properties:
      image: postgres:15-alpine
      resources:
        requests:
          cpu: 1.0
          memoryInGb: 1.5
      ports:
      - port: 5432
        protocol: TCP
      environmentVariables:
      - name: POSTGRES_USER
        value: postgres
      - name: POSTGRES_PASSWORD
        secureValue: ChangeMe@123456
      - name: POSTGRES_DB
        value: observer
      volumeMounts:
      - name: postgres-data
        mountPath: /var/lib/postgresql/data
  
  osType: Linux
  restartPolicy: Always
  ipAddress:
    type: Public
    ports:
    - protocol: TCP
      port: 8000
    - protocol: TCP
      port: 5432
    dnsNameLabel: observer-prod
  
  imageRegistryCredentials:
  - server: observercontainerreg.azurecr.io
    username: observercontainerreg
    password: <ACR_PASSWORD>
  
  volumes:
  - name: logs
    emptyDir: {}
  - name: config
    emptyDir: {}
  - name: data
    emptyDir: {}
  - name: postgres-data
    emptyDir: {}
