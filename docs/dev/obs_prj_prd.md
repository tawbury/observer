
---

# PRD v0.1 확정본

**Project:** Stock Observer (KIS Snapshot Logger)  
**Version:** v0.1 (Finalized)  
**Goal:** 한국투자증권 API 기반 스냅샷 로그 수집을 서버 상시 구동으로 안정 운영

---

## 1. 목적 (Purpose)

한국투자증권(KIS) API(REST + WebSocket)를 통해 시장 데이터를 **스냅샷으로 지속 수집**하고,  
이를 **재현 가능한 원천 로그(Raw)와 가공 데이터(DB)**로 분리 저장하여 향후 분석/패턴 파이프라인의 입력으로 사용한다.

---

## 2. 최우선 가치 및 우선순위 (Priorities)

- **안정성(가중 6):** 장애가 발생해도 “무슨 일이 있었는지”와 “결손/완화 여부”가 반드시 증거로 남아야 한다.
    
- **최대한 많은 로그(가중 4):** 가능한 범위 내에서 최대한 기록하되, 생존을 위해 필요한 경우에만 최소한의 완화(2Hz→1Hz)를 적용한다.
    

---

## 3. 범위 (Scope)

### In Scope

- Universe 선정 및 일자 스냅샷 고정
    
- 2트랙 수집(Track A: REST / Track B: WS)
    
- 스냅샷 로그 저장(파티셔닝/로테이션) 및 system 이벤트 로그
    
- Scalp 41슬롯 운영 + Overflow Ledger(초과 후보 전부 기록)
    
- ETL(서버) 및 DB 유지 정책
    
- 로컬 윈도우 PC로 백업(21:00 Pull) + 실패 시 gap-fill 재시도
    
- 운영 안정성(이상일 판정/완화/재연결) 규칙
    
- 보안(키/토큰 로그 기록 금지, 백업 최소권한)
    

### Out of Scope

- 실시간 매매/주문 실행
    
- 신호 생성/매매 판단 로직(초기)
    
- UI 대시보드(초기)
    

---

## 4. 데이터 소스 및 제약 (Data Source & Constraints)

- **Data Source:** 한국투자증권 API (REST + WebSocket)
    
- **Constraints:** 호출 제한/동시 구독/토큰 만료/재연결 등의 제약은 존재하며, 실제 제한값은 운영 계측으로 확정한다.  
    제약이 임계에 근접하면 **주기 완화, 구독 제한, 2서버 분리 옵션**을 사용한다.
    

---

## 5. Universe 정책 (Universe)

- 전체 약 3,000 심볼 중 **전일 종가 4,000원 이상**을 Universe로 사용
    
- Universe는 **일자 스냅샷 파일로 고정**한다.
    
    - 예: `universe/YYYYMMDD.json`
        
- 장중 가격 변동과 무관하게 당일 Universe 구성은 **고정**(재현성 우선)
    

---

## 6. 수집 구조 (Collection Architecture)

### Track A — Swing/Portfolio (REST, 저속)

- 시간: **09:00~15:30**
    
- 기본 주기: **10분** (필요 시 완화 가능)
    
- 대상: Universe(≥4,000원, 전일 종가 기준) (예상 ~1,500)
    
- 필드: 스윙/포트폴리오에 필요한 최소 필드(불필요 확장 금지)
    

### Track B — Scalp (WebSocket, 고속)

- 시간: **09:30~15:00**
    
- 기본 기록: **0.5초(2Hz)**
    
- 폭주/리스크 시 완화: **1초(1Hz)** (완화 정책은 13장 참조)
    
- 동시 보장: **41 종목(활성 고빈도 슬롯)**
    
- Watchlist 정책: 기본은 “비워둔다”를 지향하되,  
    **이벤트 탐지 입력원(Candidate Monitor)은 별도 계층으로 존재해야 한다.**
    
    - Observer 엔진은 “판단”이 아니라 “스냅샷 로깅”에 집중한다.
        
    - 선정/주기/완화 정책은 분리된 Policy로 구현 가능해야 한다.
        

---

## 7. 41 종목 초과 처리 (Overflow Ledger) — 확정

- 41 초과 후보 발생 시 다음을 **전부 기록**
    
    - 선정된 41개
        
    - 탈락한 나머지 전부
        
    - 당시 조건: 시간, 트리거 타입, 점수/우선순위, 시스템 상태 요약(자원, 완화 레벨, WS 상태)
        
- 목적: “그 순간 후보였음”을 증빙하여 결손 해석 가능하게 함
    

---

## 8. Scalp 트리거 셋 — 확정

(갭/시초가 급변 제외, 4가지 + 급등락 유지)

1. 거래량 급증(1순위)
    
2. 체결 속도 증가(2순위)
    
3. 변동성 급증(3순위)
    
4. 수동 트리거(보조/강제)
    

- 급등락(Price Spike) 기본 유지(초기 오탐 최소화를 위해 거래량/체결속도 중심 안정화)
    

---

## 9. 로그 파티셔닝/로테이션 (Logging & Partitioning)

### 디렉토리 구조 — 확정

- `swing/` : Swing 전종목 스캔 로그
    
- `scalp/` : Scalp 고빈도 스냅샷 로그
    
- `system/` : Overflow Ledger + 상태 이벤트(WS 끊김/완화/ETL/백업 결과 등)
    

### 파일 단위 — 혼합 정책(확정)

- Swing: **1시간 단위**
    
- Scalp: **평시 5분 단위**를 기본으로 하되,
    
    - 이벤트/리스크 시 단계적으로 더 촘촘한 기록(최대 tick 수준까지) 전환 가능
        
- System: **일 단위 + 이벤트 단위**
    

### 무결성 패키징 — 확정

- 백업/전송 단위(“하루 패키지”)에는 반드시 포함:
    
    - `manifest.json` (대상 목록/메타)
        
    - SHA256 해시 목록
        
    - 성공 시 `SUCCESS.marker`
        

---

## 10. 데이터 라이프사이클/리텐션 (Retention & Lifecycle)

### Raw(아카이브 원본)

- 서버 보관: **기본 3일**
    
- 이상일 자동 연장: **7일**
    
- **백업 미성공일은 삭제 금지(backup-first 확장)**
    
- 최장 보관 캡: **최대 10일**
    
- 압축: **하지 않음(원본 그대로)**
    

### DB(가공 데이터)

- 서버 보관: **30일**
    
- 30일 초과분: **로컬(윈도우 PC)로 자동 백업**
    
- 서버 삭제: **백업 성공 확인 이후 정리 가능(backup-first)**
    

---

## 11. 백업 자동화 (Windows PC Pull) — 확정

- 백업 실행: **매일 21:00**
    
- 방식: 서버가 PC로 푸시가 아니라 **PC가 서버에서 당겨오는(pull) 방식**
    
- 절차:
    
    1. 서버에서 백업 대상 목록(매니페스트) 산출
        
    2. PC가 21:00에 접속해 “누락 포함 대상” 다운로드
        
    3. 해시 검증 후 SUCCESS.marker 기록
        
- 실패 처리:
    
    - 다음날 21:00에 **전일 실패분 + 당일분** 함께 백업 (gap-fill)
        

---

## 12. 운영 모니터링(지표 전부 포함) — 확정

system 로그로 반드시 남길 항목:

- WS 연결 상태, 재연결 횟수, 끊김 누적 시간
    
- Track A/B 기록률·드롭률
    
- 디스크 사용률 및 쓰기 지연, 로테이션 성공 여부
    
- 이벤트 큐 지연(백프레셔)
    
- 41 슬롯 점유율/교체 횟수, overflow 발생 횟수
    
- ETL 성공 여부
    
- 백업 성공 여부(SUCCESS.marker 기준)
    

---

## 13. 운영 안정성 정책 (Finalized Policies)

### 13.1 이상일 판정(자동 7일 연장 트리거) — **확정**

아래 중 하나라도 충족하면 해당 날짜를 **이상일로 마킹**한다.

- WS 재연결 횟수 **≥ 20회/일**
    
- WS 연결 끊김 누적 **≥ 10분/일**
    
- 로그 공백 **60초 이상**이 **2회 이상/일**
    
- Scalp 기록률이 기대치 대비 **< 97%** 상태가 **5분 이상 지속**
    
- CPU **≥ 85%** 상태가 **10분 이상 지속**
    
- 디스크 사용률 **> 80%**
    
- ETL 실패(당일 DB 생성 실패)
    
- 백업 실패(21:00 pull 실패)
    
- 수동 마킹: **필드만 제공(Blank), 필요 시 사용**
    

### 13.2 자동 완화(2Hz→1Hz) — **확정**

- Level 1(1Hz) 발동 조건: 아래 중 하나가 **5분 지속**
    
    - CPU **≥ 80%**
        
    - 메모리 **≥ 85%**
        
    - 디스크 쓰기 지연 평균 **≥ 500ms**
        
    - 이벤트 큐 지연 **≥ 2초**
        
- 복구(1Hz→2Hz): 안정 상태가 **10분 지속**
    
    - CPU < 65%, 메모리 < 75%, 쓰기 지연 < 200ms, 큐 지연 < 0.5초
        

### 13.3 WebSocket 재연결(backoff) — **확정**

- 지수 백오프(지터 포함):
    
    - 1s → 2s → 5s → 10s → 20s → 30s → 이후 60s 반복
        
- 모든 disconnect/reconnect 시도는 system 로그에 기록
    
- 연속 실패 **5분**이면:
    
    - Scalp 고빈도 기록은 **일시 중지 가능**
        
    - system 로그에 원인/상태를 강하게 기록
        
    - 해당 날짜는 이상일로 마킹(리텐션 자동 연장 규칙 적용)
        

---

## 14. ETL 실패 처리 — 확정(혼합)

- ETL이 실패하더라도 **백업은 Raw 기준으로 진행**(데이터 보존 우선)
    
- ETL 실패는 **이상일로 마킹**하여 Raw 7일(최대 10일 캡) 연장 규칙 적용
    

---

## 15. 보안/권한 — 확정

- 백업 접근: **백업 전용 계정 + 읽기 전용 경로 + 키 분리(B안)**
    
- **API 키/토큰 로그 기록 금지: Yes(확정)**
    
    - 위반 시 즉시 중단/폐기/키 로테이션을 운영 규칙으로 둔다.
        

---

## 16. 수용 기준(Acceptance Criteria) — v0.1

- AC-01: `universe/YYYYMMDD.json`이 매 영업일 생성되고 당일 수집은 해당 스냅샷을 참조한다.
    
- AC-02: Track A는 09:00~15:30 동안 10분 주기로 로그를 생성한다(누락은 system 로그로 원인 기록).
    
- AC-03: Track B는 활성 슬롯에 대해 2Hz 로그를 생성하며, 완화 시 1Hz로 전환되고 system 로그에 레벨/원인/시각이 남는다.
    
- AC-04: 41 초과 시 Overflow Ledger에 후보 전수가 기록된다.
    
- AC-05: 21:00 PC pull 백업이 manifest+hash 검증을 수행하고 SUCCESS.marker를 남긴다.
    
- AC-06: 백업 실패 시 다음날 누락분 포함(gap-fill)로 자동 복구된다.
    
- AC-07: Raw 리텐션은 backup-first + 이상일 7일 + 최대 10일 캡을 준수한다.
    
- AC-08: 로그에 API 키/토큰이 기록되지 않는다(검증 체크 포함).
    

---

## 17. 다음 단계: 서버 스펙/용량 기재(계획)

본 PRD v0.1을 기준으로 다음을 산출한다.

- 일/주/월 로그량 추정(Track A/B + system)
    
- 디스크 용량(최악 케이스 포함), IOPS/쓰기 지연 목표, CPU/메모리 가이드
    
- 1대→2대 분리 시 스펙 분리안(Scalp 전용 서버 vs Swing/ETL 서버)
    

---
