# Phase 02: KIS Integration

**목적:** KIS API 연동 및 스냅샷 수집 파이프라인 구축  
**선수 조건:** Phase 01 Foundation 완료  
**완료 기준:** KIS → 스냅샷 → 아카이브 전체 흐름 동작, 재시도/백오프 정책 적용

---

## 개요

### 목표
- 한국투자증권(KIS) API와 안정적인 연동 구축
- REST/WebSocket 연결 및 인증 처리
- 결정론적 스냅샷 수집 테스트 하니스 구현
- 최소 엔드투엔드 흐름 검증

### 배경
Phase 03의 로그 생성 문제는 외부 KIS API 연동 부재가 원인입니다. 안정적인 스냅샷 생성을 위해 KIS 연동이 필수적입니다.

---

## Deliverables

- [ ] KIS API 인증/토큰 처리 구현
- [ ] REST/WebSocket 연결 관리자
- [ ] 재시도/백오프 정책 구현
- [ ] 스냅샷 수집 테스트 하니스
- [ ] 엔드투엔드 흐름 증명

---

## Tasks

### 1. KIS 인증/토큰 처리
- [ ] KIS API 인증 정보 계약 확인
  - [ ] 필요한 인증 정보 목록 추출
  - [ ] 토큰 발급/갱신 프로세스 확인
  - [ ] 보안 저장 방식 결정 (환경변수/파일)
- [ ] 인증 관리자 구현
  - [ ] 토큰 발급 함수 구현
  - [ ] 토큰 만료 감지 및 자동 갱신
  - [ ] 인증 실패 처리 로직
- [ ] Secrets 계약 준수
  - [ ] 인증 정보가 코드에 하드코딩되지 않음
  - [ ] 로그에 민감 정보 노출 없음

### 2. REST/WebSocket 연결 관리
- [ ] REST API 연결 구현
  - [ ] HTTP 클라이언트 설정 (타임아웃, 헤더)
  - [ ] Rate Limit 준수 (20 req/sec, 1000 req/min)
  - [ ] 응답 파싱 및 에러 처리
- [ ] WebSocket 연결 구현 (필요시)
  - [ ] WebSocket 클라이언트 설정
  - [ ] 연결 끊김 감지 및 재연결
  - [ ] 메시지 수신 처리
- [ ] 연결 상태 모니터링
  - [ ] 헬스체크 함수 구현
  - [ ] 연결 상태 로깅
  - [ ] 장애 알림 메커니즘

### 3. 재시도/백오프 정책
- [ ] 재시도 정책 구현
  - [ ] 재시도 횟수 제한 설정
  - [ ] 지수 백오프 알고리즘 구현
  - [ ] 재시도 가능 여부 판단 로직
- [ ] 에러 분류 및 처리
  - [ ] 일시적 오류 (네트워크, 타임아웃)
  - [ ] 영구적 오류 (인증, 권한)
  - [ ] Rate Limit 오류 특별 처리
- [ ] 장애 복구 자동화
  - [ ] 연결 복구 시 데이터 보상 로직
  - [ ] 장애 기록 및 분석

### 4. 결정론적 스냅샷 수집
- [ ] 스냅샷 생성 함수 구현
  - [ ] KIS API 응답을 ObservationSnapshot 변환
  - [ ] 필수 필드 누락 검증
  - [ ] 데이터 타입 및 형식 검증
- [ ] 수집 스케줄러 구현
  - [ ] Swing 모드: 2-3분 간격 전체 종목 스캔
  - [ ] Scalp 모드: 1초 간격 특정 종목 스캔
  - [ ] 시장 시간 고려 (09:00-15:30)
- [ ] 테스트 하니스 구현
  - [ ] Mock KIS API 서버 구현
  - [ ] 다양한 응답 시나리오 제공
  - [ ] 수집 결과 검증 자동화

### 5. 최소 엔드투엔드 흐름
- [ ] KIS → 스냅샷 파이프라인 연결
  - [ ] KIS API → ObservationSnapshot 변환
  - [ ] Observer.on_snapshot() 호출 연결
  - [ ] Validation → Guard → Enrichment 흐름 확인
- [ ] 아카이브 출력 확인
  - [ ] JSONL 파일 생성 확인
  - [ ] 파일 내용 검증
  - [ ] 롤링 정책 동작 확인
- [ ] 흐름 모니터링
  - [ ] 수집된 스냅샷 수 카운트
  - [ ] 처리 실패율 모니터링
  - [ ] 파일 크기 증가 확인

---

## Test Plan

### 환경 준비
1. KIS API 개발 계정 확보
2. 인증 정보 환경변수 설정
3. Mock 서버 구축 (테스트용)

### 실행 단계
1. 인증 테스트
   - 토큰 발급 테스트
   - 만료 및 갱신 테스트
   - 인증 실패 시나리오

2. 연결 테스트
   - REST API 호출 성공 확인
   - Rate Limit 준수 확인
   - 네트워크 장애 복구 테스트

3. 수집 테스트
   - 단일 종목 수집 테스트
   - 전체 종목 수집 테스트
   - 스케줄러 동작 확인

4. 엔드투엔드 테스트
   - KIS → 아카이브 전체 흐름
   - 장애 시나리오 복구 테스트
   - 장시간 운영 안정성 테스트

---

## Done Criteria

### 기술적 완료
- [ ] KIS API 인증이 자동으로 처리됨
- [ ] Rate Limit을 준수하며 안정적으로 데이터 수집됨
- [ ] 네트워크 장애 시 자동 복구됨
- [ ] KIS 데이터가 JSONL 아카이브로 정상 출력됨

### 운영적 완료
- [ ] 24시간 연속 운영 시 안정성 증명
- [ ] 장애 발생 시 자동 복구 시간 < 5분
- [ ] 데이터 누락률 < 0.1%

### 문서적 완료
- [ ] KIS 연동 계약이 코드에 반영됨
- [ ] 운영 가이드와 장애 처리 절차 문서화
- [ ] 모니터링 지표와 알림 설정 완료

---

## 의존성

- **선수 조건:** Phase 01 Foundation (환경/경로 계약)
- **후속 영향:** Phase 03 Archive Stabilization (로그 생성 원천 제공)

---

## 리스크 및 완화

### 고위험
- KIS API Rate Limit 초과 → 수집 중단
- 인증 토큰 만료 처리 미흡 → 연결 끊김
- 네트워크 불안정 → 데이터 누락

### 완화 조치
- Rate Limit 모니터링 및 동적 조절
- 토큰 만료 예측 및 선갱신
- 데이터 보상 및 재시도 정책 구현
