# Phase 04: Trading DB Runner (Reserved)

**목적:** Archive → Trading DB 변환 (자동매매/분석용 DB)  
**상태:** 예약 단계, Phase 03 안정화 후 진행  
**선수 조건:** Phase 03 Archive Stabilization 완료  

---

## 개요

### 목표
- JSONL 아카이브를 자동매매/분석용 DB로 변환
- 최소한의 ETL 파이프라인 구현
- Idempotency 및 Watermark 개념 적용

### 예약 사유
Phase 03의 로그 생성 안정화가 최우선 과제입니다. 아카이브 데이터가 안정적으로 생성된 후 ETL 파이프라인을 구축합니다.

---

## Deliverables (최소 범위)

- [ ] DB 형태 선택 결정
- [ ] Idempotency 키 구현
- [ ] Watermark 처리 구현
- [ ] 최소 스키마 정의
- [ ] Archive→DB 변환 스모크 테스트

---

## Tasks (최소 범위)

### 1. DB 형태 선택 결정
- [ ] 운영 요구사항 분석
  - [ ] 동시 사용자 수 확인
  - [ ] 분석 쿼리 성능 요구사항
  - [ ] 운영 복잡도 허용 수준
- [ ] DB 형태 결정
  - [ ] SQLite: 단일 서버, 간단 운영 선택 시
  - [ ] DuckDB: 분석 성능 중요 시
  - [ ] PostgreSQL: 다중 사용자 필요 시
- [ ] 결정 근거 문서화
  - [ ] 선택 기준 정리
  - [ ] 장단점 분석
  - [ ] 향후 확장 계획

### 2. Idempotency 키 구현
- [ ] 중복 방지 키 설계
  - [ ] 기본 키: session_id + timestamp + symbol
  - [ ] 추가 키: provider + data_type
  - [ ] 키 생성 로직 구현
- [ ] UPSERT 로직 구현
  - [ ] INSERT ON CONFLICT UPDATE 구현
  - [ ] 중복 데이터 감지 및 처리
  - [ ] 성능 최적화 (인덱스)
- [ ] 키 충돌 테스트
  - [ ] 동일 데이터 재처리 시나리오
  - [ ] 부분 업데이트 시나리오
  - [ ] 대량 데이터 충돌 테스트

### 3. Watermark 처리 구현
- [ ] Watermark 개념 설계
  - [ ] 처리 완료 기준점 정의
  - [ ] 증분 처리 기준 구현
  - [ ] 롤백/재처리 로직
- [ ] 처리 상태 추적
  - [ ] 마지막 처리 위치 저장
  - [ ] 처리 실패 복구 로직
  - [ ] 재시작 시 이어서 처리
- [ ] 백필 처리
  - [ ] 과거 데이터 재처리 지원
  - [ ] 데이터 일관성 보장
  - [ ] 성능 최적화

### 4. 최소 스키마 정의
- [ ] 기본 테이블 구조
  - [ ] 스냅샷 데이터 테이블
  - [ ] 처리 상태 테이블
  - [ ] 메타데이터 테이블
- [ ] 데이터 타입 매핑
  - [ ] JSONL → DB 타입 변환
  - [ ] 타임스탬프 처리
  - [ ] JSON 필드 처리
- [ ] 인덱스 설계
  - [ ] 검색 성능 최적화
  - [ ] 중복 방지 인덱스
  - [ ] 시간 범위 쿼리 최적화

### 5. Archive→DB 변환 스모크 테스트
- [ ] 변환 파이프라인 구현
  - [ ] JSONL 파일 읽기
  - [ ] 데이터 파싱 및 검증
  - [ ] DB 삽입 로직
- [ ] 기본 테스트 케이스
  - [ ] 단일 파일 변환 테스트
  - [ ] 다중 파일 순차 처리
  - [ ] 에러 핸들링 테스트
- [ ] 성능 벤치마크
  - [ ] 1,000 레코드 처리 시간
  - [ ] 메모리 사용량
  - [ ] 디스크 I/O 패턴

---

## Test Plan (최소 범위)

### 환경 준비
1. Phase 03에서 생성된 샘플 아카이브 데이터
2. 선택된 DB 엔진 설치
3. 테스트 데이터셋 준비

### 실행 단계
1. 기능 테스트
   - Idempotency 키 동작 확인
   - Watermark 처리 정확성
   - 스키마 일관성 검증

2. 성능 테스트
   - 변환 속도 측정
   - 동시 처리 안정성
   - 메모리 사용량 모니터링

3. 안정성 테스트
   - 장시간 실행 안정성
   - 에러 복구 능력
   - 데이터 무결성 검증

---

## Done Criteria (최소 범위)

### 기술적 완료
- [ ] 선택된 DB 형태로 아카이브 데이터 변환됨
- [ ] 중복 데이터가 자동으로 제거됨
- [ ] 증분 처리가 정상적으로 동작함
- [ ] 기본 스키마로 쿼리 가능함

### 운영적 완료
- [ ] 수동으로 변환 파이프라인 실행 가능
- [ ] 기본 모니터링 지표 수집 가능
- [ ] 에러 발생 시 원인 파악 가능

---

## 보류된 작업

### 상세 구현 (보류)
- [ ] 실시간 ETL 파이프라인
- [ ] 다중 테이블 조인 최적화
- [ ] 복잡한 데이터 가공 로직
- [ ] 웹 기반 관리 인터페이스

### 확장 기능 (보류)
- [ ] 다중 DB 지원
- [ ] 분산 처리
- [ ] 고급 분석 기능
- [ ] 자동 스케일링

---

## 의존성

- **선수 조건:** Phase 03 Archive Stabilization (안정적 아카이브 데이터)
- **후속 영향:** 자동매매/분석 시스템 (DB 소비자)

---

## 리스크 및 완화

### 중위험
- DB 형태 선택 오류 → 나중에 마이그레이션 필요
- 성능 부족 → 대규모 데이터 처리 불가
- 스키마 불일치 → 데이터 손실

### 완화 조치
- 단계적 확장 가능한 설계
- 성능 테스트 선행
- 스키마 버전 관리 도입

---

## 다음 단계 (Phase 03 완료 후)

1. **Phase 04.1:** 최소 ETL 파이프라인 구현
2. **Phase 04.2:** 성능 최적화 및 확장
3. **Phase 04.3:** 실시간 처리 및 고급 기능

---

**참고:** 이 Phase는 Phase 03 완료 후 우선순위 재평가 필요. 현재는 최소 범위의 예약된 계획만 정의됨.
